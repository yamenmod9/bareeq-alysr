<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bareeq Al-Yusr - BNPL Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 30px;
        }
        
        header h1 {
            font-size: 2.5em;
            color: #00d4ff;
            margin-bottom: 10px;
        }
        
        header h2 {
            font-size: 1.5em;
            color: #ffd700;
            font-weight: normal;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 12px 24px;
            background: #2d2d44;
            border: none;
            color: #fff;
            cursor: pointer;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .nav-tab:hover, .nav-tab.active {
            background: #00d4ff;
            color: #1a1a2e;
        }
        
        .tab-content {
            display: none;
            background: #2d2d44;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section {
            margin-bottom: 25px;
        }
        
        .section h3 {
            color: #00d4ff;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 6px;
            background: #1a1a2e;
            color: #fff;
            font-size: 1em;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #00d4ff;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #00d4ff;
            color: #1a1a2e;
        }
        
        .btn-success {
            background: #00c853;
            color: #fff;
        }
        
        .btn-warning {
            background: #ffd700;
            color: #1a1a2e;
        }
        
        .btn-danger {
            background: #ff5252;
            color: #fff;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .response-box {
            background: #1a1a2e;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .response-box pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #0f0;
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
        }
        
        .response-box.error pre {
            color: #ff5252;
        }
        
        .status-bar {
            display: flex;
            gap: 20px;
            background: #1a1a2e;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
        }
        
        .status-dot.online {
            background: #00c853;
        }
        
        .status-dot.offline {
            background: #ff5252;
        }
        
        .card {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .card h4 {
            color: #ffd700;
            margin-bottom: 10px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .info-text {
            color: #888;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .token-display {
            background: #0a0a15;
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.8em;
            color: #00d4ff;
            max-height: 80px;
            overflow-y: auto;
        }
        
        .hidden {
            display: none;
        }
        
        .user-info {
            background: linear-gradient(135deg, #00d4ff20, #ffd70020);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåü Bareeq Al-Yusr</h1>
            <h2>ÿ®ÿ±ŸäŸÇ ÿßŸÑŸäÿ≥ÿ± - Buy Now Pay Later Platform</h2>
        </header>
        
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <span class="status-dot" id="serverStatus"></span>
                <span>Server: <span id="serverStatusText">Checking...</span></span>
            </div>
            <div class="status-item">
                <span class="status-dot" id="authStatus"></span>
                <span>Auth: <span id="authStatusText">Not logged in</span></span>
            </div>
            <div class="status-item">
                <span>Role: <span id="userRole">-</span></span>
            </div>
            <div class="status-item">
                <span>User ID: <span id="userId">-</span></span>
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('setup')">üîß Setup</button>
            <button class="nav-tab" onclick="showTab('auth')">üîê Authentication</button>
            <button class="nav-tab" onclick="showTab('customer')">üë§ Customer</button>
            <button class="nav-tab" onclick="showTab('merchant')">üè™ Merchant</button>
            <button class="nav-tab" onclick="showTab('test')">üß™ Full Test</button>
        </div>
        
        <!-- Setup Tab -->
        <div id="setup" class="tab-content active">
            <div class="section">
                <h3>üöÄ Quick Setup</h3>
                <p class="info-text">Create test data and check server status</p>
                
                <div class="quick-actions" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="checkHealth()">Check Server Health</button>
                    <button class="btn btn-success" onclick="createTestData()">Create Test Data</button>
                    <button class="btn btn-warning" onclick="getConfig()">Get Configuration</button>
                </div>
                
                <div class="card">
                    <h4>üìã Test Credentials (after creating test data)</h4>
                    <p><strong>Customer:</strong> customer@test.com / password123</p>
                    <p><strong>Merchant:</strong> merchant@test.com / password123</p>
                </div>
                
                <div class="response-box">
                    <pre id="setupResponse">Click a button above to see results...</pre>
                </div>
            </div>
        </div>
        
        <!-- Authentication Tab -->
        <div id="auth" class="tab-content">
            <div class="grid">
                <div class="section">
                    <h3>üîë Login</h3>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" value="customer@test.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" value="password123">
                    </div>
                    <button class="btn btn-primary" onclick="login()">Login</button>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                </div>
                
                <div class="section">
                    <h3>üìù Register</h3>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="regEmail" placeholder="newuser@test.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="regPassword" placeholder="password123">
                    </div>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="regName" placeholder="Ahmed Mohammed">
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <select id="regRole">
                            <option value="customer">Customer</option>
                            <option value="merchant">Merchant</option>
                        </select>
                    </div>
                    <div class="form-group" id="shopNameGroup" style="display:none;">
                        <label>Shop Name (for merchants)</label>
                        <input type="text" id="regShopName" placeholder="My Shop">
                    </div>
                    <button class="btn btn-success" onclick="register()">Register</button>
                </div>
            </div>
            
            <div class="section">
                <h3>üé´ Current Token</h3>
                <div class="token-display" id="tokenDisplay">No token - Please login</div>
            </div>
            
            <div class="response-box">
                <pre id="authResponse">Login or register to see results...</pre>
            </div>
        </div>
        
        <!-- Customer Tab -->
        <div id="customer" class="tab-content">
            <div class="user-info" id="customerInfo">
                <h4>üë§ Customer Profile</h4>
                <p>Login as a customer to see profile</p>
            </div>
            
            <div class="quick-actions">
                <button class="btn btn-primary" onclick="getCustomerProfile()">Get Profile</button>
                <button class="btn btn-warning" onclick="getPendingRequests()">Pending Requests</button>
                <button class="btn btn-success" onclick="getTransactions('customer')">My Transactions</button>
                <button class="btn btn-primary" onclick="getRepaymentPlans()">Repayment Plans</button>
            </div>
            
            <div class="grid">
                <div class="section">
                    <h3>‚úÖ Accept Purchase</h3>
                    <div class="form-group">
                        <label>Request ID</label>
                        <input type="number" id="acceptRequestId" placeholder="1">
                    </div>
                    <button class="btn btn-success" onclick="acceptPurchase()">Accept Purchase</button>
                </div>
                
                <div class="section">
                    <h3>üìà Update Credit Limit</h3>
                    <div class="form-group">
                        <label>New Limit (SAR)</label>
                        <input type="number" id="newLimit" placeholder="5000">
                    </div>
                    <button class="btn btn-warning" onclick="updateLimit()">Request Limit Update</button>
                </div>
                
                <div class="section">
                    <h3>üìÖ Select Repayment Plan</h3>
                    <div class="form-group">
                        <label>Transaction ID</label>
                        <input type="number" id="planTransactionId" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label>Plan Type (months)</label>
                        <select id="planType">
                            <option value="1">1 Month</option>
                            <option value="3">3 Months</option>
                            <option value="6">6 Months</option>
                            <option value="12">12 Months</option>
                            <option value="18">18 Months</option>
                            <option value="24">24 Months</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="selectPlan()">Select Plan</button>
                </div>
                
                <div class="section">
                    <h3>üí≥ Make Payment</h3>
                    <div class="form-group">
                        <label>Transaction ID</label>
                        <input type="number" id="paymentTransactionId" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label>Amount (SAR)</label>
                        <input type="number" id="paymentAmount" placeholder="500">
                    </div>
                    <button class="btn btn-success" onclick="makePayment()">Make Payment</button>
                </div>
            </div>
            
            <div class="response-box">
                <pre id="customerResponse">Customer actions will appear here...</pre>
            </div>
        </div>
        
        <!-- Merchant Tab -->
        <div id="merchant" class="tab-content">
            <div class="user-info" id="merchantInfo">
                <h4>üè™ Merchant Profile</h4>
                <p>Login as a merchant to see profile</p>
            </div>
            
            <div class="quick-actions">
                <button class="btn btn-primary" onclick="getMerchantProfile()">Get Profile</button>
                <button class="btn btn-warning" onclick="getMerchantPendingRequests()">Pending Requests</button>
                <button class="btn btn-success" onclick="getTransactions('merchant')">My Transactions</button>
                <button class="btn btn-primary" onclick="getSettlements()">Settlements</button>
                <button class="btn btn-warning" onclick="getMerchantStats()">Statistics</button>
            </div>
            
            <div class="grid">
                <div class="section">
                    <h3>üì§ Send Purchase Request</h3>
                    <div class="form-group">
                        <label>Customer ID</label>
                        <input type="number" id="customerId" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label>Product Name</label>
                        <input type="text" id="productName" placeholder="Samsung Galaxy S24">
                    </div>
                    <div class="form-group">
                        <label>Price (SAR)</label>
                        <input type="number" id="productPrice" placeholder="1500">
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="productQty" value="1">
                    </div>
                    <button class="btn btn-primary" onclick="sendPurchaseRequest()">Send Request</button>
                </div>
                
                <div class="section">
                    <h3>üí∞ Receive Settlement</h3>
                    <div class="form-group">
                        <label>Transaction ID</label>
                        <input type="number" id="settlementTransactionId" placeholder="1">
                    </div>
                    <button class="btn btn-success" onclick="receiveSettlement()">Request Settlement</button>
                    <p class="info-text">Platform takes 0.5% commission</p>
                </div>
                
                <div class="section">
                    <h3>üîç Lookup Customer</h3>
                    <div class="form-group">
                        <label>Customer ID</label>
                        <input type="number" id="lookupCustomerId" placeholder="1">
                    </div>
                    <button class="btn btn-warning" onclick="lookupCustomer()">Lookup</button>
                </div>
            </div>
            
            <div class="response-box">
                <pre id="merchantResponse">Merchant actions will appear here...</pre>
            </div>
        </div>
        
        <!-- Full Test Tab -->
        <div id="test" class="tab-content">
            <div class="section">
                <h3>üß™ Complete Flow Test</h3>
                <p class="info-text">Run a complete BNPL transaction flow automatically</p>
                
                <div class="card">
                    <h4>Test Flow Steps:</h4>
                    <ol style="margin-left: 20px; line-height: 2;">
                        <li>Create test data (customer & merchant)</li>
                        <li>Login as merchant</li>
                        <li>Send purchase request to customer</li>
                        <li>Login as customer</li>
                        <li>Accept purchase request</li>
                        <li>Select repayment plan</li>
                        <li>Make payment</li>
                        <li>Login as merchant & request settlement</li>
                    </ol>
                </div>
                
                <button class="btn btn-success" onclick="runFullTest()" style="font-size: 1.2em; padding: 15px 30px;">
                    üöÄ Run Complete Test
                </button>
                
                <div class="response-box" style="max-height: 600px;">
                    <pre id="testResponse">Click "Run Complete Test" to start...</pre>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = '';  // Same origin
        let authToken = localStorage.getItem('authToken') || '';
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
            updateAuthUI();
            
            // Show/hide shop name for merchant registration
            document.getElementById('regRole').addEventListener('change', (e) => {
                document.getElementById('shopNameGroup').style.display = 
                    e.target.value === 'merchant' ? 'block' : 'none';
            });
        });
        
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }
        
        function updateAuthUI() {
            const authDot = document.getElementById('authStatus');
            const authText = document.getElementById('authStatusText');
            const userRole = document.getElementById('userRole');
            const userId = document.getElementById('userId');
            const tokenDisplay = document.getElementById('tokenDisplay');
            
            if (authToken && currentUser) {
                authDot.classList.add('online');
                authDot.classList.remove('offline');
                authText.textContent = currentUser.email || 'Logged in';
                userRole.textContent = currentUser.role || '-';
                userId.textContent = currentUser.user_id || '-';
                tokenDisplay.textContent = authToken.substring(0, 50) + '...';
            } else {
                authDot.classList.remove('online');
                authDot.classList.add('offline');
                authText.textContent = 'Not logged in';
                userRole.textContent = '-';
                userId.textContent = '-';
                tokenDisplay.textContent = 'No token - Please login';
            }
        }
        
        async function apiCall(endpoint, method = 'GET', body = null, responseId = 'setupResponse') {
            const responseBox = document.getElementById(responseId);
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (authToken) {
                    options.headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(API_BASE + endpoint, options);
                const data = await response.json();
                
                responseBox.parentElement.classList.toggle('error', !response.ok);
                responseBox.textContent = JSON.stringify(data, null, 2);
                
                return { ok: response.ok, data };
            } catch (error) {
                responseBox.parentElement.classList.add('error');
                responseBox.textContent = `Error: ${error.message}`;
                return { ok: false, error };
            }
        }
        
        // Setup Functions
        async function checkHealth() {
            const result = await apiCall('/health', 'GET', null, 'setupResponse');
            const serverDot = document.getElementById('serverStatus');
            const serverText = document.getElementById('serverStatusText');
            
            if (result.ok) {
                serverDot.classList.add('online');
                serverDot.classList.remove('offline');
                serverText.textContent = 'Online';
            } else {
                serverDot.classList.remove('online');
                serverDot.classList.add('offline');
                serverText.textContent = 'Offline';
            }
        }
        
        async function createTestData() {
            await apiCall('/api/admin/create-test-data', 'POST', null, 'setupResponse');
        }
        
        async function getConfig() {
            await apiCall('/config', 'GET', null, 'setupResponse');
        }
        
        // Auth Functions
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const result = await apiCall('/auth/login', 'POST', { email, password }, 'authResponse');
            
            if (result.ok && result.data.data) {
                authToken = result.data.data.access_token;
                currentUser = {
                    email,
                    user_id: result.data.data.user_id,
                    role: result.data.data.role
                };
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateAuthUI();
                
                // Load profile based on role
                if (currentUser.role === 'customer') {
                    getCustomerProfile();
                } else if (currentUser.role === 'merchant') {
                    getMerchantProfile();
                }
            }
        }
        
        function logout() {
            authToken = '';
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            updateAuthUI();
            document.getElementById('authResponse').textContent = 'Logged out successfully';
        }
        
        async function register() {
            const body = {
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                full_name: document.getElementById('regName').value,
                role: document.getElementById('regRole').value
            };
            
            if (body.role === 'merchant') {
                body.shop_name = document.getElementById('regShopName').value;
            }
            
            await apiCall('/auth/register', 'POST', body, 'authResponse');
        }
        
        // Customer Functions
        async function getCustomerProfile() {
            const result = await apiCall('/customers/me', 'GET', null, 'customerResponse');
            if (result.ok && result.data.data) {
                const c = result.data.data;
                document.getElementById('customerInfo').innerHTML = `
                    <h4>üë§ Customer Profile</h4>
                    <p><strong>Credit Limit:</strong> ${c.credit_limit} SAR</p>
                    <p><strong>Available Balance:</strong> ${c.available_balance} SAR</p>
                    <p><strong>Outstanding:</strong> ${c.outstanding_balance} SAR</p>
                    <p><strong>Status:</strong> ${c.status}</p>
                `;
            }
        }
        
        async function getPendingRequests() {
            await apiCall('/customers/pending-requests', 'GET', null, 'customerResponse');
        }
        
        async function getRepaymentPlans() {
            await apiCall('/customers/repayment-plans', 'GET', null, 'customerResponse');
        }
        
        async function acceptPurchase() {
            const request_id = parseInt(document.getElementById('acceptRequestId').value);
            await apiCall('/customers/accept-purchase', 'POST', { request_id }, 'customerResponse');
        }
        
        async function updateLimit() {
            const new_limit = parseFloat(document.getElementById('newLimit').value);
            await apiCall('/customers/update-limit', 'PATCH', { new_limit }, 'customerResponse');
        }
        
        async function selectPlan() {
            const transaction_id = parseInt(document.getElementById('planTransactionId').value);
            const plan_type = parseInt(document.getElementById('planType').value);
            await apiCall('/customers/select-repayment-plan', 'POST', { transaction_id, plan_type }, 'customerResponse');
        }
        
        async function makePayment() {
            const transaction_id = parseInt(document.getElementById('paymentTransactionId').value);
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            await apiCall('/customers/make-payment', 'POST', { transaction_id, amount }, 'customerResponse');
        }
        
        // Merchant Functions
        async function getMerchantProfile() {
            const result = await apiCall('/merchants/me', 'GET', null, 'merchantResponse');
            if (result.ok && result.data.data) {
                const m = result.data.data;
                document.getElementById('merchantInfo').innerHTML = `
                    <h4>üè™ Merchant Profile</h4>
                    <p><strong>Shop:</strong> ${m.shop_name}</p>
                    <p><strong>Total Transactions:</strong> ${m.total_transactions}</p>
                    <p><strong>Total Volume:</strong> ${m.total_volume} SAR</p>
                    <p><strong>Status:</strong> ${m.status}</p>
                `;
            }
        }
        
        async function getMerchantPendingRequests() {
            await apiCall('/merchants/pending-requests', 'GET', null, 'merchantResponse');
        }
        
        async function getSettlements() {
            await apiCall('/merchants/settlements', 'GET', null, 'merchantResponse');
        }
        
        async function getMerchantStats() {
            await apiCall('/merchants/stats', 'GET', null, 'merchantResponse');
        }
        
        async function getTransactions(role) {
            const responseId = role === 'customer' ? 'customerResponse' : 'merchantResponse';
            await apiCall(`/${role}s/transactions`, 'GET', null, responseId);
        }
        
        async function sendPurchaseRequest() {
            const body = {
                customer_id: parseInt(document.getElementById('customerId').value),
                product_name: document.getElementById('productName').value,
                price: parseFloat(document.getElementById('productPrice').value),
                quantity: parseInt(document.getElementById('productQty').value)
            };
            await apiCall('/merchants/send-purchase-request', 'POST', body, 'merchantResponse');
        }
        
        async function receiveSettlement() {
            const transaction_id = parseInt(document.getElementById('settlementTransactionId').value);
            await apiCall('/merchants/receive-settlement', 'POST', { transaction_id }, 'merchantResponse');
        }
        
        async function lookupCustomer() {
            const customerId = document.getElementById('lookupCustomerId').value;
            await apiCall(`/merchants/lookup-customer/${customerId}`, 'GET', null, 'merchantResponse');
        }
        
        // Full Test
        async function runFullTest() {
            const log = (msg) => {
                document.getElementById('testResponse').textContent += msg + '\n';
            };
            
            document.getElementById('testResponse').textContent = 'üöÄ Starting Full Test...\n\n';
            
            try {
                // Step 1: Create test data
                log('üì¶ Step 1: Creating test data...');
                let result = await apiCall('/api/admin/create-test-data', 'POST', null, 'testResponse');
                log(result.ok ? '‚úÖ Test data created (or already exists)\n' : '‚ö†Ô∏è Test data may already exist\n');
                
                // Step 2: Login as merchant
                log('üîê Step 2: Logging in as merchant...');
                result = await apiCall('/auth/login', 'POST', {
                    email: 'merchant@test.com',
                    password: 'password123'
                }, 'testResponse');
                
                if (!result.ok) {
                    log('‚ùå Merchant login failed');
                    return;
                }
                
                const merchantToken = result.data.data.access_token;
                authToken = merchantToken;
                log('‚úÖ Merchant logged in\n');
                
                // Step 3: Send purchase request
                log('üì§ Step 3: Sending purchase request...');
                result = await apiCall('/merchants/send-purchase-request', 'POST', {
                    customer_id: 1,
                    product_name: 'Test Product - iPhone 15',
                    price: 1000,
                    quantity: 1
                }, 'testResponse');
                
                if (!result.ok) {
                    log('‚ùå Failed to send purchase request: ' + JSON.stringify(result.data));
                    return;
                }
                
                const requestId = result.data.data.request_id;
                log(`‚úÖ Purchase request sent (ID: ${requestId})\n`);
                
                // Step 4: Login as customer
                log('üîê Step 4: Logging in as customer...');
                result = await apiCall('/auth/login', 'POST', {
                    email: 'customer@test.com',
                    password: 'password123'
                }, 'testResponse');
                
                if (!result.ok) {
                    log('‚ùå Customer login failed');
                    return;
                }
                
                authToken = result.data.data.access_token;
                log('‚úÖ Customer logged in\n');
                
                // Step 5: Accept purchase
                log('‚úÖ Step 5: Accepting purchase request...');
                result = await apiCall('/customers/accept-purchase', 'POST', {
                    request_id: requestId
                }, 'testResponse');
                
                if (!result.ok) {
                    log('‚ùå Failed to accept purchase: ' + JSON.stringify(result.data));
                    return;
                }
                
                const transactionId = result.data.data.transaction_id;
                log(`‚úÖ Purchase accepted (Transaction ID: ${transactionId})\n`);
                
                // Step 6: Select repayment plan
                log('üìÖ Step 6: Selecting 3-month repayment plan...');
                result = await apiCall('/customers/select-repayment-plan', 'POST', {
                    transaction_id: transactionId,
                    plan_type: 3
                }, 'testResponse');
                
                log(result.ok ? '‚úÖ Repayment plan selected\n' : '‚ö†Ô∏è Plan selection: ' + JSON.stringify(result.data) + '\n');
                
                // Step 7: Make payment (full amount to complete transaction)
                log('üí≥ Step 7: Making payment of 1000 SAR (full amount)...');
                result = await apiCall('/customers/make-payment', 'POST', {
                    transaction_id: transactionId,
                    amount: 1000
                }, 'testResponse');
                
                log(result.ok ? '‚úÖ Payment made\n' : '‚ö†Ô∏è Payment: ' + JSON.stringify(result.data) + '\n');
                
                // Step 8: Merchant settlement
                log('üí∞ Step 8: Merchant requesting settlement...');
                authToken = merchantToken;
                result = await apiCall('/merchants/receive-settlement', 'POST', {
                    transaction_id: transactionId
                }, 'testResponse');
                
                log(result.ok ? '‚úÖ Settlement requested\n' : '‚ö†Ô∏è Settlement: ' + JSON.stringify(result.data) + '\n');
                
                log('\nüéâ FULL TEST COMPLETED! üéâ');
                log('\nCheck the Customer and Merchant tabs for more details.');
                
            } catch (error) {
                log('‚ùå Error: ' + error.message);
            }
            
            // Reset auth
            authToken = localStorage.getItem('authToken') || '';
        }
    </script>
</body>
</html>
